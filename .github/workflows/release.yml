name: Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          gcc \
          g++ \
          make \
          python3-dev \
          python3-pip \
          libpython3-dev \
          pkg-config \
          tar \
          gzip
        python -m pip install --upgrade pip
        pip install numpy scipy
        
    - name: Build release version
      run: |
        ./manager.sh build
        
    - name: Create delivery package
      run: |
        # å¦‚æœæœ‰deliveryå‘½ä»¤ï¼Œä½¿ç”¨å®ƒ
        if grep -q "delivery" manager.sh; then
          ./manager.sh delivery
        else
          # æ‰‹åŠ¨åˆ›å»ºå‘å¸ƒåŒ…
          mkdir -p release
          cp -r bin lib include examples docs README.md release/
          tar -czf BellhopPropagationModel-release.tar.gz -C release .
        fi
        
    - name: List release files
      run: |
        echo "=== Release files ==="
        find . -name "*.tar.gz" -o -name "*Release*" -o -name "*Delivery*" | head -10
        ls -la *.tar.gz || echo "No tar.gz files found"
        
    - name: Get release version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        release_name: BellhopPropagationModel ${{ steps.get_version.outputs.version }}
        body: |
          ## BellhopPropagationModel Release ${{ steps.get_version.outputs.version }}
          
          ### ğŸ“¦ åŒ…å«å†…å®¹
          - ğŸ”§ ç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶
          - ğŸ“š åŠ¨æ€åº“æ–‡ä»¶
          - ğŸ“– å¤´æ–‡ä»¶å’Œæ–‡æ¡£
          - ğŸ”¬ ä½¿ç”¨ç¤ºä¾‹
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          ```bash
          # è§£å‹å‘å¸ƒåŒ…
          tar -xzf BellhopPropagationModel-*.tar.gz
          
          # è¿è¡Œç¨‹åº
          ./bin/BellhopPropagationModel input.json output.json
          ```
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Linux ç³»ç»Ÿ
          - Python 3.8+
          - NumPy, SciPy
          
          ---
          è‡ªåŠ¨æ„å»ºäº: ${{ github.sha }}
        draft: false
        prerelease: false
        
    - name: Upload release package
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./BellhopPropagationModel-release.tar.gz
        asset_name: BellhopPropagationModel-${{ steps.get_version.outputs.version }}-linux.tar.gz
        asset_content_type: application/gzip
        
    - name: Upload delivery package (if exists)
      if: hashFiles('**/BellhopPropagationModel_*_Delivery*.tar.gz') != ''
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./BellhopPropagationModel_*_Delivery*.tar.gz
        asset_name: BellhopPropagationModel-${{ steps.get_version.outputs.version }}-delivery.tar.gz
        asset_content_type: application/gzip
