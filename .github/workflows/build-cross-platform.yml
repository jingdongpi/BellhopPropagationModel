name: BellhopPropagationModel Interface Compliant Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-interface-compliant:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # å›½äº§åŒ–Linux ARM64å¹³å° - CentOS 8
          - platform: centos8-arm64
            docker_image: arm64v8/centos:8
            arch: linux/arm64
            gcc_target: "7.3.0"
            glibc_target: "2.28"
            linux_target: "4.19.90"
            description: "å›½äº§åŒ–Linux ARM64 (CentOS 8å…¼å®¹)"
            
          # å›½äº§åŒ–Linux ARM64å¹³å° - Debian 11  
          - platform: debian11-arm64
            docker_image: arm64v8/debian:11
            arch: linux/arm64
            gcc_target: "9.3.0"
            glibc_target: "2.31"
            linux_target: "5.4.18"
            description: "å›½äº§åŒ–Linux ARM64 (Debian 11å…¼å®¹)"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU for multi-arch
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Interface Compliant Artifacts
      run: |
        echo "================================================"
        echo "æž„å»ºç¬¦åˆå£°ä¼ æ’­æ¨¡åž‹æŽ¥å£è§„èŒƒçš„äº§ç‰©"
        echo "å¹³å°: ${{ matrix.platform }}"
        echo "æè¿°: ${{ matrix.description }}"
        echo "ç›®æ ‡ GCC: ${{ matrix.gcc_target }}"
        echo "ç›®æ ‡ glibc: ${{ matrix.glibc_target }}"
        echo "ç›®æ ‡ Linux: ${{ matrix.linux_target }}"
        echo "================================================"
        
        docker run --platform ${{ matrix.arch }} --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          -e PLATFORM=${{ matrix.platform }} \
          -e TARGET_GCC_VERSION=${{ matrix.gcc_target }} \
          -e TARGET_GLIBC_VERSION=${{ matrix.glibc_target }} \
          ${{ matrix.docker_image }} \
          /bin/bash -c "
            set -e
            
            echo '=== çŽ¯å¢ƒå‡†å¤‡ ==='
            export DEBIAN_FRONTEND=noninteractive
            
            echo '=== æ‰§è¡ŒæŽ¥å£è§„èŒƒæž„å»º ==='
            chmod +x scripts/build_complete_dual_artifacts.sh
            chmod +x scripts/build_${{ matrix.platform }}.sh
            
            # ä½¿ç”¨ç»Ÿä¸€æž„å»ºè„šæœ¬
            ./scripts/build_complete_dual_artifacts.sh ${{ matrix.platform }}
            
            echo '=== éªŒè¯äº§ç‰©ç¬¦åˆæŽ¥å£è§„èŒƒ ==='
            if [ -f 'dist/BellhopPropagationModel' ]; then
              echo 'âœ… å¯æ‰§è¡Œæ–‡ä»¶: BellhopPropagationModel'
              file dist/BellhopPropagationModel
            else
              echo 'âŒ å¯æ‰§è¡Œæ–‡ä»¶ç¼ºå¤±'
              exit 1
            fi
            
            if [ -f 'dist/libBellhopPropagationModel.so' ]; then
              echo 'âœ… åŠ¨æ€é“¾æŽ¥åº“: libBellhopPropagationModel.so'
              file dist/libBellhopPropagationModel.so
            else
              echo 'âŒ åŠ¨æ€é“¾æŽ¥åº“ç¼ºå¤±'
              exit 1
            fi
            
            if [ -f 'dist/BellhopPropagationModelInterface.h' ]; then
              echo 'âœ… å¤´æ–‡ä»¶: BellhopPropagationModelInterface.h'
            else
              echo 'âŒ å¤´æ–‡ä»¶ç¼ºå¤±'
              exit 1
            fi
            
            echo '=== æŽ¥å£è§„èŒƒéªŒè¯é€šè¿‡ ==='
          "

    - name: Test Interface Compliance
      run: |
        echo "=== æµ‹è¯•æŽ¥å£è§„èŒƒç¬¦åˆæ€§ ==="
        
        # æ£€æŸ¥æ ‡å‡†è¾“å…¥æ–‡ä»¶
        if [ -f "dist/input.json" ]; then
          echo "âœ… æ ‡å‡†è¾“å…¥æ–‡ä»¶å­˜åœ¨"
          echo "è¾“å…¥æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -10 dist/input.json
        fi
        
        # éªŒè¯äº§ç‰©ç»“æž„
        echo "=== äº§ç‰©æ¸…å• ==="
        ls -la dist/ || echo "æ— äº§ç‰©ç›®å½•"
        
        echo "=== æŽ¥å£è§„èŒƒæ£€æŸ¥ ==="
        if [ -f "INTERFACE_COMPLIANCE_REPORT.md" ]; then
          echo "âœ… æŽ¥å£è§„èŒƒæŠ¥å‘Šå­˜åœ¨"
        fi

    - name: Upload Interface Compliant Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: bellhop-interface-compliant-${{ matrix.platform }}
        path: |
          dist/
          INTERFACE_COMPLIANCE_REPORT.md
          DUAL_ARTIFACTS_BUILD_GUIDE.md
        retention-days: 30
        if-no-files-found: error

    - name: Create Interface Compliance Summary
      run: |
        echo "## ðŸŽ¯ æŽ¥å£è§„èŒƒæž„å»ºæ‘˜è¦ - ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
        echo "**å¹³å°**: ${{ matrix.description }}" >> $GITHUB_STEP_SUMMARY  
        echo "**ç›®æ ‡çŽ¯å¢ƒ**: gcc ${{ matrix.gcc_target }}, glibc ${{ matrix.glibc_target }}, linux ${{ matrix.linux_target }}+" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### âœ… æŽ¥å£è§„èŒƒç¬¦åˆæ€§" >> $GITHUB_STEP_SUMMARY
        echo "- 2.1.1 å¯æ‰§è¡Œæ–‡ä»¶: \`BellhopPropagationModel\`" >> $GITHUB_STEP_SUMMARY
        echo "- 2.1.2 åŠ¨æ€é“¾æŽ¥åº“: \`libBellhopPropagationModel.so\`" >> $GITHUB_STEP_SUMMARY
        echo "- 2.1.2 è®¡ç®—å‡½æ•°: \`SolveBellhopPropagationModel\`" >> $GITHUB_STEP_SUMMARY
        echo "- 2.1.2 å¤´æ–‡ä»¶: \`BellhopPropagationModelInterface.h\`" >> $GITHUB_STEP_SUMMARY
        echo "- 2.2 æ ‡å‡†è¾“å…¥æŽ¥å£: JSONæ ¼å¼" >> $GITHUB_STEP_SUMMARY
        echo "- 2.3 æ ‡å‡†è¾“å‡ºæŽ¥å£: JSONæ ¼å¼ï¼Œé”™è¯¯ç 200/500" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "dist" ]; then
          echo "### ðŸ“¦ æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la dist/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

  create-interface-compliant-release:
    needs: [build-interface-compliant]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Organize Interface Compliant Release
      run: |
        mkdir -p release
        
        # æ•´ç†ç¬¦åˆæŽ¥å£è§„èŒƒçš„æž„å»ºäº§ç‰©
        for platform in centos8-arm64 debian11-arm64; do
          artifact_name="bellhop-interface-compliant-$platform"
          if [ -d "$artifact_name" ]; then
            mkdir -p "release/$platform"
            cp -r "$artifact_name"/* "release/$platform/" || true
            
            # éªŒè¯å…³é”®æ–‡ä»¶
            echo "éªŒè¯ $platform å¹³å°äº§ç‰©:"
            ls -la "release/$platform/" || true
          fi
        done
        
        # åˆ›å»ºç¬¦åˆæŽ¥å£è§„èŒƒçš„å‘å¸ƒè¯´æ˜Ž
        cat > release/README.md << 'EOF'
        # BellhopPropagationModel æŽ¥å£è§„èŒƒæž„å»ºäº§ç‰©
        
        æœ¬æ¬¡å‘å¸ƒå®Œå…¨ç¬¦åˆå£°ä¼ æ’­æ¨¡åž‹æŽ¥å£è§„èŒƒè¦æ±‚ã€‚
        
        ## ðŸŽ¯ æŽ¥å£è§„èŒƒç¬¦åˆæ€§
        
        ### âœ… 2.1.1 å¯æ‰§è¡Œæ–‡ä»¶å‘½åè§„èŒƒ
        - æ–‡ä»¶å: `BellhopPropagationModel`
        - æ”¯æŒæ— å‚æ•°æ¨¡å¼: ä½¿ç”¨é»˜è®¤ `input.json` å’Œ `output.json`
        - æ”¯æŒæŒ‡å®šæ–‡ä»¶æ¨¡å¼: æ”¯æ’‘å¹¶è¡Œè®¡ç®—è°ƒç”¨
        
        ### âœ… 2.1.2 åŠ¨æ€é“¾æŽ¥åº“å‘½åè§„èŒƒ
        - åŠ¨æ€é“¾æŽ¥åº“: `libBellhopPropagationModel.so`
        - è®¡ç®—å‡½æ•°: `int SolveBellhopPropagationModel(const std::string& json, std::string& outJson)`
        - å¤´æ–‡ä»¶: `BellhopPropagationModelInterface.h`
        
        ### âœ… 2.2 & 2.3 æ ‡å‡†æŽ¥å£
        - è¾“å…¥: JSONæ ¼å¼ï¼ŒåŒ…å«å®Œæ•´å‚æ•°è§„èŒƒ
        - è¾“å‡º: JSONæ ¼å¼ï¼Œé”™è¯¯ç 200æˆåŠŸ/500å¤±è´¥
        - å•ä½ç»Ÿä¸€: è·ç¦»(m)ã€æ·±åº¦(m)ã€é¢‘çŽ‡(Hz)
        
        ## ðŸ“¦ å¹³å°æ”¯æŒ
        
        ### centos8-arm64 (å›½äº§åŒ–Linux)
        - **ç›®æ ‡çŽ¯å¢ƒ**: gcc 7.3.0ã€glibc 2.28ã€linux 4.19.90+
        - **å…¼å®¹æ€§**: CentOS 7+ã€RHEL 7+ã€éº’éºŸã€ç»Ÿä¿¡ç­‰å›½äº§åŒ–æ“ä½œç³»ç»Ÿ
        - **ç‰¹ç‚¹**: æ›´å¹¿æ³›çš„å…¼å®¹æ€§ï¼Œé€‚åˆå›½äº§åŒ–çŽ¯å¢ƒéƒ¨ç½²
        
        ### debian11-arm64 (å›½äº§åŒ–Linux)
        - **ç›®æ ‡çŽ¯å¢ƒ**: gcc 9.3.0ã€glibc 2.31ã€linux 5.4.18+
        - **å…¼å®¹æ€§**: Debian 11+ã€Ubuntu 20.04+ã€æ·±åº¦ç­‰å›½äº§åŒ–ç³»ç»Ÿ
        - **ç‰¹ç‚¹**: æ›´æ–°çš„å·¥å…·é“¾ï¼Œæ›´å¥½çš„æ€§èƒ½
        
        ## ðŸš€ äº§ç‰©è¯´æ˜Ž
        
        æ¯ä¸ªå¹³å°ç›®å½•åŒ…å«ç¬¦åˆè§„èŒƒçš„å®Œæ•´äº§ç‰©:
        
        1. **BellhopPropagationModel** - å¯æ‰§è¡Œæ–‡ä»¶
           - æ”¯æŒ `./BellhopPropagationModel` (é»˜è®¤æ–‡ä»¶)
           - æ”¯æŒ `./BellhopPropagationModel input.json output.json` (æŒ‡å®šæ–‡ä»¶)
        
        2. **libBellhopPropagationModel.so** - åŠ¨æ€é“¾æŽ¥åº“
           - C++æŽ¥å£: `SolveBellhopPropagationModel(json, outJson)`
           - é”™è¯¯ç : 200æˆåŠŸ, 500å¤±è´¥
        
        3. **BellhopPropagationModelInterface.h** - å¤´æ–‡ä»¶
           - æ ‡å‡†C++æŽ¥å£å®šä¹‰
        
        4. **input.json** - æ ‡å‡†è¾“å…¥ç¤ºä¾‹
           - ç¬¦åˆæŽ¥å£è§„èŒƒçš„å®Œæ•´è¾“å…¥æ ¼å¼
        
        5. **æµ‹è¯•æ–‡ä»¶**
           - `test_executable.sh` - å¯æ‰§è¡Œæ–‡ä»¶æµ‹è¯•
           - `test_library.cpp` - åŠ¨æ€åº“æµ‹è¯•ç¨‹åº
           - `compile_test.sh` - ç¼–è¯‘æµ‹è¯•è„šæœ¬
        
        ## ðŸ“‹ ä½¿ç”¨æ–¹æ³•
        
        ### å¯æ‰§è¡Œæ–‡ä»¶ä½¿ç”¨
        ```bash
        # ä¸‹è½½å¯¹åº”å¹³å°çš„äº§ç‰©
        cd centos8-arm64/  # æˆ– debian11-arm64/
        
        # æ–¹å¼1: ä½¿ç”¨é»˜è®¤æ–‡ä»¶
        ./BellhopPropagationModel
        
        # æ–¹å¼2: æŒ‡å®šæ–‡ä»¶ (æ”¯æŒå¹¶è¡Œ)
        ./BellhopPropagationModel task1_input.json task1_output.json
        ```
        
        ### åŠ¨æ€é“¾æŽ¥åº“ä½¿ç”¨
        ```cpp
        #include "BellhopPropagationModelInterface.h"
        
        std::string input_json = "...";  // ç¬¦åˆè§„èŒƒçš„JSONè¾“å…¥
        std::string output_json;
        int result = SolveBellhopPropagationModel(input_json, output_json);
        
        if (result == 200) {
            // å¤„ç†æˆåŠŸ
        } else {
            // å¤„ç†å¤±è´¥
        }
        ```
        
        ## âœ… è´¨é‡ä¿è¯
        
        - å®Œå…¨ç¬¦åˆå£°ä¼ æ’­æ¨¡åž‹æŽ¥å£è§„èŒƒ
        - è‡ªåŒ…å«éƒ¨ç½²ï¼Œæ— éœ€PythonçŽ¯å¢ƒ
        - æ”¯æŒå›½äº§åŒ–æ“ä½œç³»ç»Ÿ
        - é€šè¿‡æŽ¥å£è§„èŒƒéªŒè¯æµ‹è¯•
        - æ”¯æŒå•æœºã€é›†ç¾¤ã€è¶…ç®—å¹¶è¡Œè®¡ç®—
        EOF
      
    - name: Create Interface Compliant Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: interface-v${{ github.run_number }}
        name: BellhopPropagationModel Interface Compliant v${{ github.run_number }}
        body_path: release/README.md
        files: release/**/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
