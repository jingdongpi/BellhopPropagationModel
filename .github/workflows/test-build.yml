name: Test Build

on:
  workflow_dispatch:
    inputs:
      test_platform:
        description: 'æµ‹è¯•å¹³å°'
        required: true
        default: 'debian11-x64'
        type: choice
        options:
          - 'debian11-x64'
          - 'centos7-x64'
          - 'win11-x64'
      python_version:
        description: 'Pythonç‰ˆæœ¬'
        required: true
        default: '3.8'
        type: choice
        options:
          - '3.8'
          - '3.9'

jobs:
  test-build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - platform: debian11-x64
            os: ubuntu-22.04
            docker_image: debian:11
            setup_script: debian11_setup.sh
          - platform: centos7-x64
            os: ubuntu-22.04
            docker_image: centos:7
            setup_script: centos7_setup.sh
          - platform: win11-x64
            os: windows-2022
            docker_image: ""
            setup_script: ""
    
    # åªè¿è¡Œé€‰ä¸­çš„å¹³å°
    if: ${{ matrix.platform == github.event.inputs.test_platform }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ github.event.inputs.python_version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ github.event.inputs.python_version }}

    - name: Test Windows Build
      if: matrix.platform == 'win11-x64'
      run: |
        Write-Host "=== æµ‹è¯• Windows æž„å»º ==="
        
        # å®‰è£…åŸºç¡€ä¾èµ–
        python -m pip install --upgrade pip
        python -m pip install nuitka wheel setuptools numpy scipy
        
        # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        Write-Host "=== ç³»ç»Ÿä¿¡æ¯ ==="
        python --version
        python -c "import sys; print(f'Python executable: {sys.executable}')"
        python -c "import platform; print(f'Architecture: {platform.machine()}')"
        
        # æµ‹è¯• Python æ¨¡å—ç¼–è¯‘
        if (Test-Path "scripts/compile_nuitka_cross_platform.py") {
          Write-Host "æ‰¾åˆ° Nuitka ç¼–è¯‘è„šæœ¬"
          python scripts/compile_nuitka_cross_platform.py || Write-Host "Nuitka ç¼–è¯‘å¤±è´¥ï¼Œä½†ç»§ç»­"
        } else {
          Write-Host "æœªæ‰¾åˆ° Nuitka ç¼–è¯‘è„šæœ¬"
        }
        
        # åˆ›å»ºæµ‹è¯•äº§ç‰©
        mkdir -p bin, lib, include
        echo "Windows test binary" > bin/test.exe
        echo "Windows test library" > lib/test.dll
        echo "Windows test header" > include/test.h
        
        Write-Host "=== Windows æž„å»ºæµ‹è¯•å®Œæˆ ==="
      shell: pwsh

    - name: Set up Docker Buildx
      if: matrix.platform != 'win11-x64'
      uses: docker/setup-buildx-action@v3

    - name: Test Linux Build with Docker
      if: matrix.platform != 'win11-x64'
      run: |
        echo "=== æµ‹è¯• Linux æž„å»º: ${{ matrix.platform }} ==="
        
        # æ£€æŸ¥ Docker è®¾ç½®è„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ ! -f "docker-local/${{ matrix.setup_script }}" ]; then
          echo "é”™è¯¯: æ‰¾ä¸åˆ°è®¾ç½®è„šæœ¬ docker-local/${{ matrix.setup_script }}"
          exit 1
        fi
        
        echo "Docker é•œåƒ: ${{ matrix.docker_image }}"
        echo "è®¾ç½®è„šæœ¬: ${{ matrix.setup_script }}"
        
        # åˆ›å»ºç®€åŒ–çš„ Dockerfile
        cat > Dockerfile.test << EOF
        FROM ${{ matrix.docker_image }}
        
        # å¤åˆ¶è®¾ç½®è„šæœ¬
        COPY docker-local/${{ matrix.setup_script }} /setup.sh
        RUN chmod +x /setup.sh
        
        # è¿è¡Œè®¾ç½®è„šæœ¬
        RUN /setup.sh ${{ github.event.inputs.python_version }}
        
        WORKDIR /workspace
        EOF
        
        # æž„å»ºæµ‹è¯•é•œåƒ
        echo "æž„å»º Docker é•œåƒ..."
        docker build -f Dockerfile.test -t bellhop-test:${{ matrix.platform }} .
        
        # è¿è¡Œæµ‹è¯•å®¹å™¨
        echo "è¿è¡Œæµ‹è¯•å®¹å™¨..."
        docker run --rm -v $(pwd):/workspace bellhop-test:${{ matrix.platform }} bash -c "
          set -ex
          
          # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
          echo '=== ç³»ç»Ÿä¿¡æ¯ ==='
          uname -a
          cat /etc/os-release || cat /etc/centos-release || echo 'Unknown OS'
          
          echo '=== GLIBC ç‰ˆæœ¬ ==='
          ldd --version | head -1
          
          echo '=== Python ä¿¡æ¯ ==='
          python --version
          python -c 'import sys; print(f\"Python executable: {sys.executable}\")'
          
          # æµ‹è¯• Python åŒ…
          python -c 'import numpy; print(f\"NumPy: {numpy.__version__}\")'
          python -c 'import nuitka; print(f\"Nuitka: {nuitka.__version__}\")' || echo 'Nuitka å¯¼å…¥å¤±è´¥'
          
          # æ¿€æ´»ç¼–è¯‘çŽ¯å¢ƒï¼ˆCentOS 7 éœ€è¦ï¼‰
          if [ -f /opt/rh/devtoolset-7/enable ]; then
            source /opt/rh/devtoolset-7/enable
            echo 'æ¿€æ´» devtoolset-7'
          fi
          
          # æ£€æŸ¥ç¼–è¯‘å·¥å…·
          which gcc || echo 'gcc æœªæ‰¾åˆ°'
          which cmake || echo 'cmake æœªæ‰¾åˆ°'
          
          # åˆ›å»ºæµ‹è¯•äº§ç‰©
          mkdir -p bin lib include
          echo 'Linux test binary' > bin/test
          echo 'Linux test library' > lib/test.so
          echo 'Linux test header' > include/test.h
          
          echo '=== Linux æž„å»ºæµ‹è¯•å®Œæˆ ==='
        "

    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-${{ matrix.platform }}-python${{ github.event.inputs.python_version }}
        path: |
          bin/
          lib/
          include/
        retention-days: 7

    - name: Create test summary
      run: |
        echo "# ðŸ§ª æµ‹è¯•æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **å¹³å°**: ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Python ç‰ˆæœ¬**: ${{ github.event.inputs.python_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è¿è¡Œå™¨**: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "æµ‹è¯•æž„å»ºå·²å®Œæˆï¼Œè¯·æ£€æŸ¥æž„å»ºæ—¥å¿—å’Œä¸‹è½½æµ‹è¯•äº§ç‰©ã€‚" >> $GITHUB_STEP_SUMMARY
