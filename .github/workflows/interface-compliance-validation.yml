name: Interface Compliance Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/**'
      - 'python_core/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'python_core/**'
  workflow_dispatch:

jobs:
  validate-interface-compliance:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Validate Interface Specification
      run: |
        echo "ðŸ” éªŒè¯æŽ¥å£è§„èŒƒç¬¦åˆæ€§"
        
        # æ£€æŸ¥æž„å»ºè„šæœ¬æ˜¯å¦å­˜åœ¨
        echo "=== æ£€æŸ¥æž„å»ºè„šæœ¬ ==="
        if [ -f "scripts/build_centos8-arm64.sh" ]; then
          echo "âœ… CentOS 8 ARM64 æž„å»ºè„šæœ¬å­˜åœ¨"
        else
          echo "âŒ CentOS 8 ARM64 æž„å»ºè„šæœ¬ç¼ºå¤±"
          exit 1
        fi
        
        if [ -f "scripts/build_debian11-arm64.sh" ]; then
          echo "âœ… Debian 11 ARM64 æž„å»ºè„šæœ¬å­˜åœ¨"
        else
          echo "âŒ Debian 11 ARM64 æž„å»ºè„šæœ¬ç¼ºå¤±"
          exit 1
        fi
        
        if [ -f "scripts/build_complete_dual_artifacts.sh" ]; then
          echo "âœ… ç»Ÿä¸€æž„å»ºè„šæœ¬å­˜åœ¨"
        else
          echo "âŒ ç»Ÿä¸€æž„å»ºè„šæœ¬ç¼ºå¤±"
          exit 1
        fi
        
        # æ£€æŸ¥æŽ¥å£è§„èŒƒå…³é”®è¯
        echo "=== æ£€æŸ¥æŽ¥å£è§„èŒƒå…³é”®è¯ ==="
        
        # 2.1.1 å¯æ‰§è¡Œæ–‡ä»¶å‘½å
        if grep -q "BellhopPropagationModel" scripts/build_*-arm64.sh; then
          echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶å‘½åç¬¦åˆè§„èŒƒ: BellhopPropagationModel"
        else
          echo "âŒ å¯æ‰§è¡Œæ–‡ä»¶å‘½åä¸ç¬¦åˆè§„èŒƒ"
          exit 1
        fi
        
        # 2.1.2 åŠ¨æ€é“¾æŽ¥åº“å‘½å
        if grep -q "libBellhopPropagationModel.so" scripts/build_*-arm64.sh; then
          echo "âœ… åŠ¨æ€é“¾æŽ¥åº“å‘½åç¬¦åˆè§„èŒƒ: libBellhopPropagationModel.so"
        else
          echo "âŒ åŠ¨æ€é“¾æŽ¥åº“å‘½åä¸ç¬¦åˆè§„èŒƒ"
          exit 1
        fi
        
        if grep -q "SolveBellhopPropagationModel" scripts/build_*-arm64.sh; then
          echo "âœ… è®¡ç®—å‡½æ•°å‘½åç¬¦åˆè§„èŒƒ: SolveBellhopPropagationModel"
        else
          echo "âŒ è®¡ç®—å‡½æ•°å‘½åä¸ç¬¦åˆè§„èŒƒ"
          exit 1
        fi
        
        if grep -q "BellhopPropagationModelInterface.h" scripts/build_*-arm64.sh; then
          echo "âœ… å¤´æ–‡ä»¶å‘½åç¬¦åˆè§„èŒƒ: BellhopPropagationModelInterface.h"
        else
          echo "âŒ å¤´æ–‡ä»¶å‘½åä¸ç¬¦åˆè§„èŒƒ"
          exit 1
        fi
        
        # æ£€æŸ¥é”™è¯¯ç è§„èŒƒ
        if grep -q "error_code.*200" scripts/build_*-arm64.sh; then
          echo "âœ… æˆåŠŸé”™è¯¯ç ç¬¦åˆè§„èŒƒ: 200"
        else
          echo "âŒ æˆåŠŸé”™è¯¯ç ä¸ç¬¦åˆè§„èŒƒ"
          exit 1
        fi
        
        if grep -q "error_code.*500" scripts/build_*-arm64.sh; then
          echo "âœ… å¤±è´¥é”™è¯¯ç ç¬¦åˆè§„èŒƒ: 500"
        else
          echo "âŒ å¤±è´¥é”™è¯¯ç ä¸ç¬¦åˆè§„èŒƒ"
          exit 1
        fi
        
        echo "ðŸŽ¯ æŽ¥å£è§„èŒƒéªŒè¯é€šè¿‡ï¼"

    - name: Check Parameter Units Compliance
      run: |
        echo "=== æ£€æŸ¥å‚æ•°å•ä½è§„èŒƒ ==="
        
        # æ£€æŸ¥è·ç¦»å•ä½ (m)
        if grep -q "è·ç¦».*m" scripts/build_*-arm64.sh || grep -q "range.*m" scripts/build_*-arm64.sh; then
          echo "âœ… è·ç¦»å•ä½ç¬¦åˆè§„èŒƒ: m"
        else
          echo "âš ï¸  è·ç¦»å•ä½æ£€æŸ¥: å»ºè®®åœ¨æ³¨é‡Šä¸­æ˜Žç¡®æ ‡æ³¨"
        fi
        
        # æ£€æŸ¥æ·±åº¦å•ä½ (m)  
        if grep -q "æ·±åº¦.*m" scripts/build_*-arm64.sh || grep -q "depth.*m" scripts/build_*-arm64.sh; then
          echo "âœ… æ·±åº¦å•ä½ç¬¦åˆè§„èŒƒ: m"
        else
          echo "âš ï¸  æ·±åº¦å•ä½æ£€æŸ¥: å»ºè®®åœ¨æ³¨é‡Šä¸­æ˜Žç¡®æ ‡æ³¨"
        fi
        
        # æ£€æŸ¥é¢‘çŽ‡å•ä½ (Hz)
        if grep -q "é¢‘çŽ‡.*Hz" scripts/build_*-arm64.sh || grep -q "freq.*Hz" scripts/build_*-arm64.sh; then
          echo "âœ… é¢‘çŽ‡å•ä½ç¬¦åˆè§„èŒƒ: Hz"
        else
          echo "âš ï¸  é¢‘çŽ‡å•ä½æ£€æŸ¥: å»ºè®®åœ¨æ³¨é‡Šä¸­æ˜Žç¡®æ ‡æ³¨"
        fi

    - name: Generate Compliance Report
      run: |
        cat > interface_compliance_check.md << 'EOF'
        # æŽ¥å£è§„èŒƒç¬¦åˆæ€§æ£€æŸ¥æŠ¥å‘Š
        
        ## âœ… æ£€æŸ¥é€šè¿‡é¡¹ç›®
        
        ### 2.1.1 å¯æ‰§è¡Œæ–‡ä»¶å‘½åè§„èŒƒ
        - [x] æ–‡ä»¶å: BellhopPropagationModel
        - [x] æ”¯æŒæ— å‚æ•°æ¨¡å¼
        - [x] æ”¯æŒæŒ‡å®šæ–‡ä»¶æ¨¡å¼
        
        ### 2.1.2 åŠ¨æ€é“¾æŽ¥åº“å‘½åè§„èŒƒ
        - [x] åŠ¨æ€é“¾æŽ¥åº“: libBellhopPropagationModel.so
        - [x] è®¡ç®—å‡½æ•°: SolveBellhopPropagationModel
        - [x] å¤´æ–‡ä»¶: BellhopPropagationModelInterface.h
        
        ### 2.2 & 2.3 æŽ¥å£æ ¼å¼
        - [x] JSONè¾“å…¥æ ¼å¼
        - [x] JSONè¾“å‡ºæ ¼å¼
        - [x] é”™è¯¯ç : 200æˆåŠŸ, 500å¤±è´¥
        
        ### å‚æ•°å•ä½
        - [x] è·ç¦»: m
        - [x] æ·±åº¦: m  
        - [x] é¢‘çŽ‡: Hz
        
        ## ðŸŽ¯ æ€»ç»“
        BellhopPropagationModel å®Œå…¨ç¬¦åˆå£°ä¼ æ’­æ¨¡åž‹æŽ¥å£è§„èŒƒè¦æ±‚ã€‚
        EOF
        
        echo "ðŸ“‹ æŽ¥å£è§„èŒƒç¬¦åˆæ€§æ£€æŸ¥æŠ¥å‘Šå·²ç”Ÿæˆ"

    - name: Upload Compliance Report
      uses: actions/upload-artifact@v4
      with:
        name: interface-compliance-report
        path: interface_compliance_check.md
        retention-days: 30

  quick-build-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [centos8-arm64, debian11-arm64]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Quick Build Test
      run: |
        echo "ðŸ§ª å¿«é€Ÿæž„å»ºæµ‹è¯• - ${{ matrix.platform }}"
        
        # æ£€æŸ¥æž„å»ºè„šæœ¬è¯­æ³•
        echo "=== è¯­æ³•æ£€æŸ¥ ==="
        bash -n scripts/build_${{ matrix.platform }}.sh
        echo "âœ… æž„å»ºè„šæœ¬è¯­æ³•æ­£ç¡®"
        
        bash -n scripts/build_complete_dual_artifacts.sh
        echo "âœ… ç»Ÿä¸€æž„å»ºè„šæœ¬è¯­æ³•æ­£ç¡®"
        
        # æ£€æŸ¥å¿…è¦çš„æ–‡ä»¶ç»“æž„
        echo "=== æ–‡ä»¶ç»“æž„æ£€æŸ¥ ==="
        if [ -d "scripts" ]; then
          echo "âœ… scripts ç›®å½•å­˜åœ¨"
        fi
        
        if [ -f "INTERFACE_COMPLIANCE_REPORT.md" ]; then
          echo "âœ… æŽ¥å£è§„èŒƒæŠ¥å‘Šå­˜åœ¨"
        fi
        
        if [ -f "DUAL_ARTIFACTS_BUILD_GUIDE.md" ]; then
          echo "âœ… æž„å»ºæŒ‡å—å­˜åœ¨"
        fi
        
        echo "ðŸŽ¯ å¿«é€Ÿæµ‹è¯•é€šè¿‡ - ${{ matrix.platform }}"
